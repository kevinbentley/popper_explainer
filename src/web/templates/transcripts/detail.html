{% extends "base.html" %}

{% block title %}Transcript #{{ transcript.id }} - Popper Discovery{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/transcripts">Transcripts</a></li>
                <li class="breadcrumb-item active">Transcript #{{ transcript.id }}</li>
            </ol>
        </nav>
        <h1>Transcript #{{ transcript.id }}</h1>
    </div>
</div>

<!-- Metadata -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Metadata</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">Component</dt>
                    <dd class="col-sm-8"><span class="badge bg-secondary">{{ transcript.component }}</span></dd>

                    <dt class="col-sm-4">Model</dt>
                    <dd class="col-sm-8">{{ transcript.model_name }}</dd>

                    {% if transcript.phase %}
                    <dt class="col-sm-4">Phase</dt>
                    <dd class="col-sm-8"><span class="badge bg-info">{{ transcript.phase }}</span></dd>
                    {% endif %}

                    <dt class="col-sm-4">Status</dt>
                    <dd class="col-sm-8">
                        {% if transcript.success %}
                            <span class="badge bg-success">Success</span>
                        {% else %}
                            <span class="badge bg-danger">Failed</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-4">Created</dt>
                    <dd class="col-sm-8">{{ transcript.created_at }}</dd>
                </dl>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Usage</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-4">Prompt Tokens</dt>
                    <dd class="col-sm-8">{{ transcript.prompt_tokens | format_tokens }}</dd>

                    <dt class="col-sm-4">Output Tokens</dt>
                    <dd class="col-sm-8">{{ transcript.output_tokens | format_tokens }}</dd>

                    {% if transcript.thinking_tokens %}
                    <dt class="col-sm-4">Thinking Tokens</dt>
                    <dd class="col-sm-8">{{ transcript.thinking_tokens | format_tokens }}</dd>
                    {% endif %}

                    <dt class="col-sm-4">Total Tokens</dt>
                    <dd class="col-sm-8"><strong>{{ transcript.total_tokens | format_tokens }}</strong></dd>

                    <dt class="col-sm-4">Duration</dt>
                    <dd class="col-sm-8">{{ transcript.duration_ms | format_duration }}</dd>

                    {% if transcript.run_id %}
                    <dt class="col-sm-4">Run</dt>
                    <dd class="col-sm-8">
                        <a href="/runs/{{ transcript.run_id }}">{{ transcript.run_id | truncate_text(30) }}</a>
                        {% if transcript.iteration_id is not none %}
                        (iteration {{ transcript.iteration_id }})
                        {% endif %}
                    </dd>
                    {% endif %}

                    {% if transcript.prompt_hash %}
                    <dt class="col-sm-4">Prompt Hash</dt>
                    <dd class="col-sm-8"><code>{{ transcript.prompt_hash }}</code></dd>
                    {% endif %}
                </dl>
            </div>
        </div>
    </div>
</div>

{% if transcript.error_message %}
<div class="row mb-4">
    <div class="col">
        <div class="alert alert-danger">
            <h5>Error Message</h5>
            <pre class="mb-0">{{ transcript.error_message }}</pre>
        </div>
    </div>
</div>
{% endif %}

<!-- System Instruction -->
{% if transcript.system_instruction %}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <button class="btn btn-link p-0 text-decoration-none" type="button"
                            data-bs-toggle="collapse" data-bs-target="#systemInstruction">
                        System Instruction
                    </button>
                </h5>
            </div>
            <div class="collapse" id="systemInstruction">
                <div class="card-body">
                    <pre class="prompt-text bg-light p-3 rounded">{{ transcript.system_instruction }}</pre>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Prompt -->
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Prompt</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('promptText')">
                    Copy
                </button>
            </div>
            <div class="card-body">
                <pre id="promptText" class="prompt-text bg-light p-3 rounded" style="max-height: 500px; overflow: auto;">{{ transcript.prompt }}</pre>
            </div>
        </div>
    </div>
</div>

<!-- Response -->
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Response</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard('responseText')">
                    Copy
                </button>
            </div>
            <div class="card-body">
                <pre id="responseText" class="response-text bg-light p-3 rounded" style="max-height: 600px; overflow: auto;">{{ transcript.raw_response }}</pre>
            </div>
        </div>
    </div>
</div>

<!-- Try to parse response as JSON -->
{% set parsed_response = transcript.raw_response | json_pretty %}
{% if parsed_response and parsed_response != transcript.raw_response %}
<div class="row mb-4">
    <div class="col">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Response (Formatted JSON)</h5>
            </div>
            <div class="card-body">
                <pre class="json-viewer"><code class="language-json">{{ parsed_response }}</code></pre>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function copyToClipboard(elementId) {
    const text = document.getElementById(elementId).innerText;
    navigator.clipboard.writeText(text).then(() => {
        alert('Copied to clipboard!');
    });
}
</script>
{% endblock %}
